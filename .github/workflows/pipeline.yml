name: CI/CD Pipeline with SSH

on:
  push:
    branches:
      - main  # Se déclenche lorsque du code est poussé sur la branche main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Étape 1: Checkout du code source
      - name: Checkout repo
        uses: actions/checkout@v3

      # Étape 2: Configurer SSH pour utiliser le secret
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh  # Crée le répertoire .ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa  # Copie le secret SSH dans le fichier id_rsa
          chmod 600 ~/.ssh/id_rsa  # Change les permissions pour que le fichier SSH soit privé
          ssh-keyscan github.com >> ~/.ssh/known_hosts  # Ajoute GitHub à la liste des hôtes connus

      # Étape 3: Vérifier que l'authentification SSH fonctionne
      - name: Test SSH connection
        run: ssh -T git@github.com  # Vérifie que la connexion SSH est correcte

      # Étape 4: Commit et Push des changements via SSH
      - name: Commit and Push changes to GitHub via SSH
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Automated commit from GitHub Actions" || echo "No changes to commit"
          git push git@github.com:yourusername/yourrepo.git HEAD:main  # Push via SSH
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # Si tu veux utiliser un token pour l'authentification supplémentaire
